{"ast":null,"code":"'use strict';\n\nconst Tags = require('opentracing').Tags;\n\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler');\n\nconst awsHelpers = require('./helpers');\n\nfunction createWrapRequest(tracer, config) {\n  config = normalizeConfig(config);\n  return function wrapRequest(send) {\n    return function requestWithTrace(cb) {\n      if (!this.service) return send.apply(this, arguments);\n      const serviceIdentifier = this.service.serviceIdentifier;\n\n      if (!awsHelpers.isEnabled(serviceIdentifier, config[serviceIdentifier], this)) {\n        return send.apply(this, arguments);\n      }\n\n      const serviceName = getServiceName(serviceIdentifier, tracer, config);\n      const childOf = tracer.scope().active();\n      const tags = {\n        [Tags.SPAN_KIND]: 'client',\n        'service.name': serviceName,\n        'aws.operation': this.operation,\n        'aws.region': this.service.config && this.service.config.region,\n        'aws.service': this.service.api && this.service.api.className,\n        'component': 'aws-sdk'\n      };\n      const span = tracer.startSpan('aws.request', {\n        childOf,\n        tags\n      });\n      this.on('complete', response => {\n        if (!span) return;\n        awsHelpers.addResponseTags(span, response, serviceIdentifier, config, tracer);\n        awsHelpers.finish(span, response.error);\n      });\n      analyticsSampler.sample(span, config.measured);\n      awsHelpers.requestInject(span, this, serviceIdentifier, tracer);\n      const request = this;\n      return tracer.scope().activate(span, () => {\n        if (typeof cb === 'function') {\n          arguments[0] = awsHelpers.wrapCb(cb, serviceIdentifier, tags, request, tracer, childOf);\n        }\n\n        return send.apply(this, arguments);\n      });\n    };\n  };\n}\n\nfunction createWrapSetPromisesDependency(tracer, config, instrumenter, AWS) {\n  return function wrapSetPromisesDependency(setPromisesDependency) {\n    return function setPromisesDependencyWithTrace(dep) {\n      const result = setPromisesDependency.apply(this, arguments);\n      instrumenter.wrap(AWS.Request.prototype, 'promise', createWrapRequest(tracer, config));\n      return result;\n    };\n  };\n}\n\nfunction normalizeConfig(config) {\n  const hooks = getHooks(config);\n  return Object.assign({}, config, {\n    splitByAwsService: config.splitByAwsService !== false,\n    hooks\n  });\n}\n\nfunction getHooks(config) {\n  const noop = () => {};\n\n  const request = config.hooks && config.hooks.request || noop;\n  return {\n    request\n  };\n} // TODO: test splitByAwsService when the test suite is fixed\n\n\nfunction getServiceName(serviceIdentifier, tracer, config) {\n  return config.service ? config.service : `${tracer._service}-aws-${serviceIdentifier}`;\n} // <2.1.35 has breaking changes for instrumentation\n// https://github.com/aws/aws-sdk-js/pull/629\n\n\nmodule.exports = [{\n  name: 'aws-sdk',\n  versions: ['>=2.3.0'],\n\n  patch(AWS, tracer, config) {\n    this.wrap(AWS.Request.prototype, 'promise', createWrapRequest(tracer, config));\n    this.wrap(AWS.config, 'setPromisesDependency', createWrapSetPromisesDependency(tracer, config, this, AWS));\n  },\n\n  unpatch(AWS) {\n    this.unwrap(AWS.Request.prototype, 'promise');\n    this.unwrap(AWS.config, 'setPromisesDependency');\n  }\n\n}, {\n  name: 'aws-sdk',\n  versions: ['>=2.1.35'],\n\n  patch(AWS, tracer, config) {\n    this.wrap(AWS.Request.prototype, 'send', createWrapRequest(tracer, config));\n  },\n\n  unpatch(AWS) {\n    this.unwrap(AWS.Request.prototype, 'send');\n  }\n\n}];","map":{"version":3,"sources":["/Users/danielcalderon/vinology/Vinology-client/node_modules/dd-trace/packages/datadog-plugin-aws-sdk/src/index.js"],"names":["Tags","require","analyticsSampler","awsHelpers","createWrapRequest","tracer","config","normalizeConfig","wrapRequest","send","requestWithTrace","cb","service","apply","arguments","serviceIdentifier","isEnabled","serviceName","getServiceName","childOf","scope","active","tags","SPAN_KIND","operation","region","api","className","span","startSpan","on","response","addResponseTags","finish","error","sample","measured","requestInject","request","activate","wrapCb","createWrapSetPromisesDependency","instrumenter","AWS","wrapSetPromisesDependency","setPromisesDependency","setPromisesDependencyWithTrace","dep","result","wrap","Request","prototype","hooks","getHooks","Object","assign","splitByAwsService","noop","_service","module","exports","name","versions","patch","unpatch","unwrap"],"mappings":"AAAA;;AAEA,MAAMA,IAAI,GAAGC,OAAO,CAAC,aAAD,CAAP,CAAuBD,IAApC;;AACA,MAAME,gBAAgB,GAAGD,OAAO,CAAC,sCAAD,CAAhC;;AACA,MAAME,UAAU,GAAGF,OAAO,CAAC,WAAD,CAA1B;;AAEA,SAASG,iBAAT,CAA4BC,MAA5B,EAAoCC,MAApC,EAA4C;AAC1CA,EAAAA,MAAM,GAAGC,eAAe,CAACD,MAAD,CAAxB;AACA,SAAO,SAASE,WAAT,CAAsBC,IAAtB,EAA4B;AACjC,WAAO,SAASC,gBAAT,CAA2BC,EAA3B,EAA+B;AACpC,UAAI,CAAC,KAAKC,OAAV,EAAmB,OAAOH,IAAI,CAACI,KAAL,CAAW,IAAX,EAAiBC,SAAjB,CAAP;AAEnB,YAAMC,iBAAiB,GAAG,KAAKH,OAAL,CAAaG,iBAAvC;;AAEA,UAAI,CAACZ,UAAU,CAACa,SAAX,CAAqBD,iBAArB,EAAwCT,MAAM,CAACS,iBAAD,CAA9C,EAAmE,IAAnE,CAAL,EAA+E;AAC7E,eAAON,IAAI,CAACI,KAAL,CAAW,IAAX,EAAiBC,SAAjB,CAAP;AACD;;AAED,YAAMG,WAAW,GAAGC,cAAc,CAACH,iBAAD,EAAoBV,MAApB,EAA4BC,MAA5B,CAAlC;AACA,YAAMa,OAAO,GAAGd,MAAM,CAACe,KAAP,GAAeC,MAAf,EAAhB;AACA,YAAMC,IAAI,GAAG;AACX,SAACtB,IAAI,CAACuB,SAAN,GAAkB,QADP;AAEX,wBAAgBN,WAFL;AAGX,yBAAiB,KAAKO,SAHX;AAIX,sBAAc,KAAKZ,OAAL,CAAaN,MAAb,IAAuB,KAAKM,OAAL,CAAaN,MAAb,CAAoBmB,MAJ9C;AAKX,uBAAe,KAAKb,OAAL,CAAac,GAAb,IAAoB,KAAKd,OAAL,CAAac,GAAb,CAAiBC,SALzC;AAMX,qBAAa;AANF,OAAb;AASA,YAAMC,IAAI,GAAGvB,MAAM,CAACwB,SAAP,CAAiB,aAAjB,EAAgC;AAC3CV,QAAAA,OAD2C;AAE3CG,QAAAA;AAF2C,OAAhC,CAAb;AAKA,WAAKQ,EAAL,CAAQ,UAAR,EAAoBC,QAAQ,IAAI;AAC9B,YAAI,CAACH,IAAL,EAAW;AAEXzB,QAAAA,UAAU,CAAC6B,eAAX,CAA2BJ,IAA3B,EAAiCG,QAAjC,EAA2ChB,iBAA3C,EAA8DT,MAA9D,EAAsED,MAAtE;AACAF,QAAAA,UAAU,CAAC8B,MAAX,CAAkBL,IAAlB,EAAwBG,QAAQ,CAACG,KAAjC;AACD,OALD;AAOAhC,MAAAA,gBAAgB,CAACiC,MAAjB,CAAwBP,IAAxB,EAA8BtB,MAAM,CAAC8B,QAArC;AAEAjC,MAAAA,UAAU,CAACkC,aAAX,CAAyBT,IAAzB,EAA+B,IAA/B,EAAqCb,iBAArC,EAAwDV,MAAxD;AAEA,YAAMiC,OAAO,GAAG,IAAhB;AAEA,aAAOjC,MAAM,CAACe,KAAP,GAAemB,QAAf,CAAwBX,IAAxB,EAA8B,MAAM;AACzC,YAAI,OAAOjB,EAAP,KAAc,UAAlB,EAA8B;AAC5BG,UAAAA,SAAS,CAAC,CAAD,CAAT,GAAeX,UAAU,CAACqC,MAAX,CAAkB7B,EAAlB,EAAsBI,iBAAtB,EAAyCO,IAAzC,EAA+CgB,OAA/C,EAAwDjC,MAAxD,EAAgEc,OAAhE,CAAf;AACD;;AACD,eAAOV,IAAI,CAACI,KAAL,CAAW,IAAX,EAAiBC,SAAjB,CAAP;AACD,OALM,CAAP;AAMD,KA5CD;AA6CD,GA9CD;AA+CD;;AAED,SAAS2B,+BAAT,CAA0CpC,MAA1C,EAAkDC,MAAlD,EAA0DoC,YAA1D,EAAwEC,GAAxE,EAA6E;AAC3E,SAAO,SAASC,yBAAT,CAAoCC,qBAApC,EAA2D;AAChE,WAAO,SAASC,8BAAT,CAAyCC,GAAzC,EAA8C;AACnD,YAAMC,MAAM,GAAGH,qBAAqB,CAAChC,KAAtB,CAA4B,IAA5B,EAAkCC,SAAlC,CAAf;AAEA4B,MAAAA,YAAY,CAACO,IAAb,CAAkBN,GAAG,CAACO,OAAJ,CAAYC,SAA9B,EAAyC,SAAzC,EAAoD/C,iBAAiB,CAACC,MAAD,EAASC,MAAT,CAArE;AAEA,aAAO0C,MAAP;AACD,KAND;AAOD,GARD;AASD;;AAED,SAASzC,eAAT,CAA0BD,MAA1B,EAAkC;AAChC,QAAM8C,KAAK,GAAGC,QAAQ,CAAC/C,MAAD,CAAtB;AAEA,SAAOgD,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBjD,MAAlB,EAA0B;AAC/BkD,IAAAA,iBAAiB,EAAElD,MAAM,CAACkD,iBAAP,KAA6B,KADjB;AAE/BJ,IAAAA;AAF+B,GAA1B,CAAP;AAID;;AAED,SAASC,QAAT,CAAmB/C,MAAnB,EAA2B;AACzB,QAAMmD,IAAI,GAAG,MAAM,CAAE,CAArB;;AACA,QAAMnB,OAAO,GAAIhC,MAAM,CAAC8C,KAAP,IAAgB9C,MAAM,CAAC8C,KAAP,CAAad,OAA9B,IAA0CmB,IAA1D;AAEA,SAAO;AAAEnB,IAAAA;AAAF,GAAP;AACD,C,CAED;;;AACA,SAASpB,cAAT,CAAyBH,iBAAzB,EAA4CV,MAA5C,EAAoDC,MAApD,EAA4D;AAC1D,SAAOA,MAAM,CAACM,OAAP,GACHN,MAAM,CAACM,OADJ,GAEF,GAAEP,MAAM,CAACqD,QAAS,QAAO3C,iBAAkB,EAFhD;AAGD,C,CAED;AACA;;;AACA4C,MAAM,CAACC,OAAP,GAAiB,CACf;AACEC,EAAAA,IAAI,EAAE,SADR;AAEEC,EAAAA,QAAQ,EAAE,CAAC,SAAD,CAFZ;;AAGEC,EAAAA,KAAK,CAAEpB,GAAF,EAAOtC,MAAP,EAAeC,MAAf,EAAuB;AAC1B,SAAK2C,IAAL,CAAUN,GAAG,CAACO,OAAJ,CAAYC,SAAtB,EAAiC,SAAjC,EAA4C/C,iBAAiB,CAACC,MAAD,EAASC,MAAT,CAA7D;AACA,SAAK2C,IAAL,CAAUN,GAAG,CAACrC,MAAd,EAAsB,uBAAtB,EAA+CmC,+BAA+B,CAACpC,MAAD,EAASC,MAAT,EAAiB,IAAjB,EAAuBqC,GAAvB,CAA9E;AACD,GANH;;AAOEqB,EAAAA,OAAO,CAAErB,GAAF,EAAO;AACZ,SAAKsB,MAAL,CAAYtB,GAAG,CAACO,OAAJ,CAAYC,SAAxB,EAAmC,SAAnC;AACA,SAAKc,MAAL,CAAYtB,GAAG,CAACrC,MAAhB,EAAwB,uBAAxB;AACD;;AAVH,CADe,EAaf;AACEuD,EAAAA,IAAI,EAAE,SADR;AAEEC,EAAAA,QAAQ,EAAE,CAAC,UAAD,CAFZ;;AAGEC,EAAAA,KAAK,CAAEpB,GAAF,EAAOtC,MAAP,EAAeC,MAAf,EAAuB;AAC1B,SAAK2C,IAAL,CAAUN,GAAG,CAACO,OAAJ,CAAYC,SAAtB,EAAiC,MAAjC,EAAyC/C,iBAAiB,CAACC,MAAD,EAASC,MAAT,CAA1D;AACD,GALH;;AAME0D,EAAAA,OAAO,CAAErB,GAAF,EAAO;AACZ,SAAKsB,MAAL,CAAYtB,GAAG,CAACO,OAAJ,CAAYC,SAAxB,EAAmC,MAAnC;AACD;;AARH,CAbe,CAAjB","sourcesContent":["'use strict'\n\nconst Tags = require('opentracing').Tags\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler')\nconst awsHelpers = require('./helpers')\n\nfunction createWrapRequest (tracer, config) {\n  config = normalizeConfig(config)\n  return function wrapRequest (send) {\n    return function requestWithTrace (cb) {\n      if (!this.service) return send.apply(this, arguments)\n\n      const serviceIdentifier = this.service.serviceIdentifier\n\n      if (!awsHelpers.isEnabled(serviceIdentifier, config[serviceIdentifier], this)) {\n        return send.apply(this, arguments)\n      }\n\n      const serviceName = getServiceName(serviceIdentifier, tracer, config)\n      const childOf = tracer.scope().active()\n      const tags = {\n        [Tags.SPAN_KIND]: 'client',\n        'service.name': serviceName,\n        'aws.operation': this.operation,\n        'aws.region': this.service.config && this.service.config.region,\n        'aws.service': this.service.api && this.service.api.className,\n        'component': 'aws-sdk'\n      }\n\n      const span = tracer.startSpan('aws.request', {\n        childOf,\n        tags\n      })\n\n      this.on('complete', response => {\n        if (!span) return\n\n        awsHelpers.addResponseTags(span, response, serviceIdentifier, config, tracer)\n        awsHelpers.finish(span, response.error)\n      })\n\n      analyticsSampler.sample(span, config.measured)\n\n      awsHelpers.requestInject(span, this, serviceIdentifier, tracer)\n\n      const request = this\n\n      return tracer.scope().activate(span, () => {\n        if (typeof cb === 'function') {\n          arguments[0] = awsHelpers.wrapCb(cb, serviceIdentifier, tags, request, tracer, childOf)\n        }\n        return send.apply(this, arguments)\n      })\n    }\n  }\n}\n\nfunction createWrapSetPromisesDependency (tracer, config, instrumenter, AWS) {\n  return function wrapSetPromisesDependency (setPromisesDependency) {\n    return function setPromisesDependencyWithTrace (dep) {\n      const result = setPromisesDependency.apply(this, arguments)\n\n      instrumenter.wrap(AWS.Request.prototype, 'promise', createWrapRequest(tracer, config))\n\n      return result\n    }\n  }\n}\n\nfunction normalizeConfig (config) {\n  const hooks = getHooks(config)\n\n  return Object.assign({}, config, {\n    splitByAwsService: config.splitByAwsService !== false,\n    hooks\n  })\n}\n\nfunction getHooks (config) {\n  const noop = () => {}\n  const request = (config.hooks && config.hooks.request) || noop\n\n  return { request }\n}\n\n// TODO: test splitByAwsService when the test suite is fixed\nfunction getServiceName (serviceIdentifier, tracer, config) {\n  return config.service\n    ? config.service\n    : `${tracer._service}-aws-${serviceIdentifier}`\n}\n\n// <2.1.35 has breaking changes for instrumentation\n// https://github.com/aws/aws-sdk-js/pull/629\nmodule.exports = [\n  {\n    name: 'aws-sdk',\n    versions: ['>=2.3.0'],\n    patch (AWS, tracer, config) {\n      this.wrap(AWS.Request.prototype, 'promise', createWrapRequest(tracer, config))\n      this.wrap(AWS.config, 'setPromisesDependency', createWrapSetPromisesDependency(tracer, config, this, AWS))\n    },\n    unpatch (AWS) {\n      this.unwrap(AWS.Request.prototype, 'promise')\n      this.unwrap(AWS.config, 'setPromisesDependency')\n    }\n  },\n  {\n    name: 'aws-sdk',\n    versions: ['>=2.1.35'],\n    patch (AWS, tracer, config) {\n      this.wrap(AWS.Request.prototype, 'send', createWrapRequest(tracer, config))\n    },\n    unpatch (AWS) {\n      this.unwrap(AWS.Request.prototype, 'send')\n    }\n  }\n]\n"]},"metadata":{},"sourceType":"script"}