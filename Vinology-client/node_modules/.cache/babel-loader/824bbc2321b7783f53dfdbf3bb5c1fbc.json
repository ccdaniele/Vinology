{"ast":null,"code":"'use strict'; // TODO: either instrument all or none of the render functions\n\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler');\n\nfunction createWrapHandleRequest(tracer, config) {\n  return function wrapHandleRequest(handleRequest) {\n    return function handleRequestWithTrace(req, res, pathname, query) {\n      return trace(tracer, config, req, res, () => handleRequest.apply(this, arguments));\n    };\n  };\n}\n\nfunction createWrapHandleApiRequest(tracer, config) {\n  return function wrapHandleApiRequest(handleApiRequest) {\n    return function handleApiRequestWithTrace(req, res, pathname, query) {\n      return trace(tracer, config, req, res, () => {\n        const promise = handleApiRequest.apply(this, arguments);\n        promise.then(handled => {\n          if (!handled) return;\n          const page = getPageFromPath(pathname, this.dynamicRoutes);\n          addPage(req, page);\n        });\n        return promise;\n      });\n    };\n  };\n}\n\nfunction createWrapRenderToResponse(tracer, config) {\n  return function wrapRenderToResponse(renderToResponse) {\n    return function renderToResponseWithTrace(ctx) {\n      return trace(tracer, config, ctx.req, ctx.res, () => renderToResponse.apply(this, arguments));\n    };\n  };\n}\n\nfunction createWrapRenderErrorToResponse(tracer, config) {\n  return function wrapRenderErrorToResponse(renderErrorToResponse) {\n    return function renderErrorToResponseWithTrace(ctx) {\n      return trace(tracer, config, ctx.req, ctx.res, () => renderErrorToResponse.apply(this, arguments));\n    };\n  };\n}\n\nfunction createWrapRenderToHTML(tracer, config) {\n  return function wrapRenderToHTML(renderToHTML) {\n    return function renderToHTMLWithTrace(req, res, pathname, query, parsedUrl) {\n      return trace(tracer, config, req, res, () => renderToHTML.apply(this, arguments));\n    };\n  };\n}\n\nfunction createWrapRenderErrorToHTML(tracer, config) {\n  return function wrapRenderErrorToHTML(renderErrorToHTML) {\n    return function renderErrorToHTMLWithTrace(err, req, res, pathname, query) {\n      return trace(tracer, config, req, res, () => renderErrorToHTML.apply(this, arguments));\n    };\n  };\n}\n\nfunction createWrapFindPageComponents(tracer, config) {\n  return function wrapFindPageComponents(findPageComponents) {\n    return function findPageComponentsWithTrace(pathname, query) {\n      const result = findPageComponents.apply(this, arguments);\n      const span = tracer.scope().active();\n      const req = span && span._nextReq;\n\n      if (result) {\n        addPage(req, pathname);\n      }\n\n      return result;\n    };\n  };\n}\n\nfunction getPageFromPath(page, dynamicRoutes = []) {\n  for (const dynamicRoute of dynamicRoutes) {\n    if (dynamicRoute.page.startsWith('/api') && dynamicRoute.match(page)) {\n      return dynamicRoute.page;\n    }\n  }\n\n  return page;\n}\n\nfunction trace(tracer, config, req, res, handler) {\n  const scope = tracer.scope();\n  if (req._datadog_next) return scope.activate(req._datadog_next.span, handler);\n  const childOf = scope.active();\n  const tags = {\n    'service.name': config.service || tracer._service,\n    'resource.name': req.method,\n    'span.type': 'web',\n    'span.kind': 'server',\n    'http.method': req.method\n  };\n  const span = tracer.startSpan('next.request', {\n    childOf,\n    tags\n  });\n  analyticsSampler.sample(span, config.measured, true);\n  req._datadog_next = {\n    span\n  };\n  const promise = scope.activate(span, handler); // HACK: Store the request object on the span for findPageComponents.\n  // TODO: Use CLS when it will be available in core.\n\n  span._nextReq = req;\n  promise.then(() => finish(span, config, req, res), err => {\n    span.setTag('error', err);\n    finish(span, config, req, res);\n  });\n  return promise;\n}\n\nfunction addPage(req, page) {\n  if (!req || !req._datadog_next) return;\n\n  req._datadog_next.span.addTags({\n    'resource.name': `${req.method} ${page}`.trim(),\n    'next.page': page\n  });\n}\n\nfunction finish(span, config, req, res) {\n  span.addTags({\n    'http.status_code': res.statusCode\n  });\n  config.hooks.request(span, req, res);\n  span.finish();\n}\n\nfunction normalizeConfig(config) {\n  const hooks = getHooks(config);\n  return Object.assign({}, config, {\n    hooks\n  });\n}\n\nfunction getHooks(config) {\n  const noop = () => {};\n\n  const request = config.hooks && config.hooks.request || noop;\n  return {\n    request\n  };\n}\n\nmodule.exports = [{\n  name: 'next',\n  versions: ['>=9.5 <11.1'],\n  file: 'dist/next-server/server/next-server.js',\n\n  patch({\n    default: Server\n  }, tracer, config) {\n    config = normalizeConfig(config);\n    this.wrap(Server.prototype, 'handleRequest', createWrapHandleRequest(tracer, config));\n    this.wrap(Server.prototype, 'handleApiRequest', createWrapHandleApiRequest(tracer, config));\n    this.wrap(Server.prototype, 'renderToHTML', createWrapRenderToHTML(tracer, config));\n    this.wrap(Server.prototype, 'renderErrorToHTML', createWrapRenderErrorToHTML(tracer, config));\n    this.wrap(Server.prototype, 'findPageComponents', createWrapFindPageComponents(tracer, config));\n  },\n\n  unpatch({\n    default: Server\n  }) {\n    this.unwrap(Server.prototype, 'handleRequest');\n    this.unwrap(Server.prototype, 'handleApiRequest');\n    this.unwrap(Server.prototype, 'renderToHTML');\n    this.unwrap(Server.prototype, 'renderErrorToHTML');\n    this.unwrap(Server.prototype, 'findPageComponents');\n  }\n\n}, {\n  name: 'next',\n  versions: ['>=11.1'],\n  file: 'dist/server/next-server.js',\n\n  patch({\n    default: Server\n  }, tracer, config) {\n    config = normalizeConfig(config);\n    this.wrap(Server.prototype, 'handleRequest', createWrapHandleRequest(tracer, config));\n    this.wrap(Server.prototype, 'handleApiRequest', createWrapHandleApiRequest(tracer, config));\n    this.wrap(Server.prototype, 'renderToResponse', createWrapRenderToResponse(tracer, config));\n    this.wrap(Server.prototype, 'renderErrorToResponse', createWrapRenderErrorToResponse(tracer, config));\n    this.wrap(Server.prototype, 'findPageComponents', createWrapFindPageComponents(tracer, config));\n  },\n\n  unpatch({\n    default: Server\n  }) {\n    this.unwrap(Server.prototype, 'handleRequest');\n    this.unwrap(Server.prototype, 'handleApiRequest');\n    this.unwrap(Server.prototype, 'renderToResponse');\n    this.unwrap(Server.prototype, 'renderErrorToResponse');\n    this.unwrap(Server.prototype, 'findPageComponents');\n  }\n\n}];","map":{"version":3,"sources":["/Users/danielcalderon/vinology/Vinology-client/node_modules/dd-trace/packages/datadog-plugin-next/src/index.js"],"names":["analyticsSampler","require","createWrapHandleRequest","tracer","config","wrapHandleRequest","handleRequest","handleRequestWithTrace","req","res","pathname","query","trace","apply","arguments","createWrapHandleApiRequest","wrapHandleApiRequest","handleApiRequest","handleApiRequestWithTrace","promise","then","handled","page","getPageFromPath","dynamicRoutes","addPage","createWrapRenderToResponse","wrapRenderToResponse","renderToResponse","renderToResponseWithTrace","ctx","createWrapRenderErrorToResponse","wrapRenderErrorToResponse","renderErrorToResponse","renderErrorToResponseWithTrace","createWrapRenderToHTML","wrapRenderToHTML","renderToHTML","renderToHTMLWithTrace","parsedUrl","createWrapRenderErrorToHTML","wrapRenderErrorToHTML","renderErrorToHTML","renderErrorToHTMLWithTrace","err","createWrapFindPageComponents","wrapFindPageComponents","findPageComponents","findPageComponentsWithTrace","result","span","scope","active","_nextReq","dynamicRoute","startsWith","match","handler","_datadog_next","activate","childOf","tags","service","_service","method","startSpan","sample","measured","finish","setTag","addTags","trim","statusCode","hooks","request","normalizeConfig","getHooks","Object","assign","noop","module","exports","name","versions","file","patch","default","Server","wrap","prototype","unpatch","unwrap"],"mappings":"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","sourcesContent":["'use strict'\n\n// TODO: either instrument all or none of the render functions\n\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler')\n\nfunction createWrapHandleRequest (tracer, config) {\n  return function wrapHandleRequest (handleRequest) {\n    return function handleRequestWithTrace (req, res, pathname, query) {\n      return trace(tracer, config, req, res, () => handleRequest.apply(this, arguments))\n    }\n  }\n}\n\nfunction createWrapHandleApiRequest (tracer, config) {\n  return function wrapHandleApiRequest (handleApiRequest) {\n    return function handleApiRequestWithTrace (req, res, pathname, query) {\n      return trace(tracer, config, req, res, () => {\n        const promise = handleApiRequest.apply(this, arguments)\n\n        promise.then(handled => {\n          if (!handled) return\n\n          const page = getPageFromPath(pathname, this.dynamicRoutes)\n\n          addPage(req, page)\n        })\n\n        return promise\n      })\n    }\n  }\n}\n\nfunction createWrapRenderToResponse (tracer, config) {\n  return function wrapRenderToResponse (renderToResponse) {\n    return function renderToResponseWithTrace (ctx) {\n      return trace(tracer, config, ctx.req, ctx.res, () => renderToResponse.apply(this, arguments))\n    }\n  }\n}\n\nfunction createWrapRenderErrorToResponse (tracer, config) {\n  return function wrapRenderErrorToResponse (renderErrorToResponse) {\n    return function renderErrorToResponseWithTrace (ctx) {\n      return trace(tracer, config, ctx.req, ctx.res, () => renderErrorToResponse.apply(this, arguments))\n    }\n  }\n}\n\nfunction createWrapRenderToHTML (tracer, config) {\n  return function wrapRenderToHTML (renderToHTML) {\n    return function renderToHTMLWithTrace (req, res, pathname, query, parsedUrl) {\n      return trace(tracer, config, req, res, () => renderToHTML.apply(this, arguments))\n    }\n  }\n}\n\nfunction createWrapRenderErrorToHTML (tracer, config) {\n  return function wrapRenderErrorToHTML (renderErrorToHTML) {\n    return function renderErrorToHTMLWithTrace (err, req, res, pathname, query) {\n      return trace(tracer, config, req, res, () => renderErrorToHTML.apply(this, arguments))\n    }\n  }\n}\n\nfunction createWrapFindPageComponents (tracer, config) {\n  return function wrapFindPageComponents (findPageComponents) {\n    return function findPageComponentsWithTrace (pathname, query) {\n      const result = findPageComponents.apply(this, arguments)\n      const span = tracer.scope().active()\n      const req = span && span._nextReq\n\n      if (result) {\n        addPage(req, pathname)\n      }\n\n      return result\n    }\n  }\n}\n\nfunction getPageFromPath (page, dynamicRoutes = []) {\n  for (const dynamicRoute of dynamicRoutes) {\n    if (dynamicRoute.page.startsWith('/api') && dynamicRoute.match(page)) {\n      return dynamicRoute.page\n    }\n  }\n\n  return page\n}\n\nfunction trace (tracer, config, req, res, handler) {\n  const scope = tracer.scope()\n\n  if (req._datadog_next) return scope.activate(req._datadog_next.span, handler)\n\n  const childOf = scope.active()\n  const tags = {\n    'service.name': config.service || tracer._service,\n    'resource.name': req.method,\n    'span.type': 'web',\n    'span.kind': 'server',\n    'http.method': req.method\n  }\n  const span = tracer.startSpan('next.request', { childOf, tags })\n\n  analyticsSampler.sample(span, config.measured, true)\n\n  req._datadog_next = { span }\n\n  const promise = scope.activate(span, handler)\n\n  // HACK: Store the request object on the span for findPageComponents.\n  // TODO: Use CLS when it will be available in core.\n  span._nextReq = req\n\n  promise.then(() => finish(span, config, req, res), err => {\n    span.setTag('error', err)\n    finish(span, config, req, res)\n  })\n\n  return promise\n}\n\nfunction addPage (req, page) {\n  if (!req || !req._datadog_next) return\n\n  req._datadog_next.span.addTags({\n    'resource.name': `${req.method} ${page}`.trim(),\n    'next.page': page\n  })\n}\n\nfunction finish (span, config, req, res) {\n  span.addTags({\n    'http.status_code': res.statusCode\n  })\n  config.hooks.request(span, req, res)\n  span.finish()\n}\n\nfunction normalizeConfig (config) {\n  const hooks = getHooks(config)\n\n  return Object.assign({}, config, { hooks })\n}\n\nfunction getHooks (config) {\n  const noop = () => {}\n  const request = (config.hooks && config.hooks.request) || noop\n\n  return { request }\n}\n\nmodule.exports = [\n  {\n    name: 'next',\n    versions: ['>=9.5 <11.1'],\n    file: 'dist/next-server/server/next-server.js',\n    patch ({ default: Server }, tracer, config) {\n      config = normalizeConfig(config)\n\n      this.wrap(Server.prototype, 'handleRequest', createWrapHandleRequest(tracer, config))\n      this.wrap(Server.prototype, 'handleApiRequest', createWrapHandleApiRequest(tracer, config))\n      this.wrap(Server.prototype, 'renderToHTML', createWrapRenderToHTML(tracer, config))\n      this.wrap(Server.prototype, 'renderErrorToHTML', createWrapRenderErrorToHTML(tracer, config))\n      this.wrap(Server.prototype, 'findPageComponents', createWrapFindPageComponents(tracer, config))\n    },\n    unpatch ({ default: Server }) {\n      this.unwrap(Server.prototype, 'handleRequest')\n      this.unwrap(Server.prototype, 'handleApiRequest')\n      this.unwrap(Server.prototype, 'renderToHTML')\n      this.unwrap(Server.prototype, 'renderErrorToHTML')\n      this.unwrap(Server.prototype, 'findPageComponents')\n    }\n  },\n\n  {\n    name: 'next',\n    versions: ['>=11.1'],\n    file: 'dist/server/next-server.js',\n    patch ({ default: Server }, tracer, config) {\n      config = normalizeConfig(config)\n\n      this.wrap(Server.prototype, 'handleRequest', createWrapHandleRequest(tracer, config))\n      this.wrap(Server.prototype, 'handleApiRequest', createWrapHandleApiRequest(tracer, config))\n      this.wrap(Server.prototype, 'renderToResponse', createWrapRenderToResponse(tracer, config))\n      this.wrap(Server.prototype, 'renderErrorToResponse', createWrapRenderErrorToResponse(tracer, config))\n      this.wrap(Server.prototype, 'findPageComponents', createWrapFindPageComponents(tracer, config))\n    },\n    unpatch ({ default: Server }) {\n      this.unwrap(Server.prototype, 'handleRequest')\n      this.unwrap(Server.prototype, 'handleApiRequest')\n      this.unwrap(Server.prototype, 'renderToResponse')\n      this.unwrap(Server.prototype, 'renderErrorToResponse')\n      this.unwrap(Server.prototype, 'findPageComponents')\n    }\n  }\n]\n"]},"metadata":{},"sourceType":"script"}