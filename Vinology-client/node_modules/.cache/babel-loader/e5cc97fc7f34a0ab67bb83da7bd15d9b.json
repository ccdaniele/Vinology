{"ast":null,"code":"'use strict';\n\nconst {\n  instrument\n} = require('./util');\n\nfunction createWrapConnectionCommand(tracer, config, name) {\n  return function wrapCommand(command) {\n    return function commandWithTrace(ns, ops) {\n      const hostParts = typeof this.address === 'string' ? this.address.split(':') : '';\n      const options = hostParts.length === 2 ? {\n        host: hostParts[0],\n        port: hostParts[1]\n      } : {}; // no port means the address is a random UUID so no host either\n\n      const topology = {\n        s: {\n          options\n        }\n      };\n      ns = `${ns.db}.${ns.collection}`;\n      return instrument(command, this, arguments, topology, ns, ops, tracer, config, {\n        name\n      });\n    };\n  };\n}\n\nfunction createWrapCommand(tracer, config, name) {\n  return function wrapCommand(command) {\n    return function commandWithTrace(server, ns, ops) {\n      return instrument(command, this, arguments, server, ns, ops, tracer, config, {\n        name\n      });\n    };\n  };\n}\n\nfunction createWrapMaybePromise(tracer, config) {\n  return function wrapMaybePromise(maybePromise) {\n    return function maybePromiseWithTrace(parent, callback, fn) {\n      const callbackIndex = arguments.length - 2;\n      callback = arguments[callbackIndex];\n\n      if (typeof callback === 'function') {\n        arguments[callbackIndex] = tracer.scope().bind(callback);\n      }\n\n      return maybePromise.apply(this, arguments);\n    };\n  };\n}\n\nfunction patch(wp, tracer, config) {\n  this.wrap(wp, 'command', createWrapCommand(tracer, config));\n  this.wrap(wp, 'insert', createWrapCommand(tracer, config, 'insert'));\n  this.wrap(wp, 'update', createWrapCommand(tracer, config, 'update'));\n  this.wrap(wp, 'remove', createWrapCommand(tracer, config, 'remove'));\n  this.wrap(wp, 'query', createWrapCommand(tracer, config));\n  this.wrap(wp, 'getMore', createWrapCommand(tracer, config, 'getMore'));\n  this.wrap(wp, 'killCursors', createWrapCommand(tracer, config, 'killCursors'));\n}\n\nfunction unpatch(wp) {\n  this.unwrap(wp, 'command');\n  this.unwrap(wp, 'insert');\n  this.unwrap(wp, 'update');\n  this.unwrap(wp, 'remove');\n  this.unwrap(wp, 'query');\n  this.unwrap(wp, 'getMore');\n  this.unwrap(wp, 'killCursors');\n}\n\nfunction patchConnection({\n  Connection\n}, tracer, config) {\n  const proto = Connection.prototype;\n  this.wrap(proto, 'command', createWrapConnectionCommand(tracer, config));\n  this.wrap(proto, 'query', createWrapConnectionCommand(tracer, config));\n  this.wrap(proto, 'getMore', createWrapConnectionCommand(tracer, config, 'getMore'));\n  this.wrap(proto, 'killCursors', createWrapConnectionCommand(tracer, config, 'killCursors'));\n}\n\nfunction unpatchConnection({\n  Connection\n}) {\n  const proto = Connection.prototype;\n  this.unwrap(proto, 'command');\n  this.unwrap(proto, 'query');\n  this.unwrap(proto, 'getMore');\n  this.unwrap(proto, 'killCursors');\n}\n\nfunction patchClass(WireProtocol, tracer, config) {\n  this.wrap(WireProtocol.prototype, 'command', createWrapCommand(tracer, config));\n}\n\nfunction unpatchClass(WireProtocol) {\n  this.unwrap(WireProtocol.prototype, 'command');\n}\n\nmodule.exports = [{\n  name: 'mongodb',\n  versions: ['>=4'],\n  file: 'lib/cmap/connection.js',\n  patch: patchConnection,\n  unpatch: unpatchConnection\n}, {\n  name: 'mongodb',\n  versions: ['>=3.5.4'],\n  file: 'lib/utils.js',\n\n  patch(util, tracer, config) {\n    this.wrap(util, 'maybePromise', createWrapMaybePromise(tracer, config));\n  },\n\n  unpatch(util) {\n    this.unwrap(util, 'maybePromise');\n  }\n\n}, {\n  name: 'mongodb',\n  versions: ['>=3.3 <4'],\n  file: 'lib/core/wireprotocol/index.js',\n  patch,\n  unpatch\n}, {\n  name: 'mongodb-core',\n  versions: ['>=3.2'],\n  file: 'lib/wireprotocol/index.js',\n  patch,\n  unpatch\n}, {\n  name: 'mongodb-core',\n  versions: ['~3.1.10'],\n  file: 'lib/wireprotocol/3_2_support.js',\n  patch: patchClass,\n  unpatch: unpatchClass\n}, {\n  name: 'mongodb-core',\n  versions: ['~3.1.10'],\n  file: 'lib/wireprotocol/2_6_support.js',\n  patch: patchClass,\n  unpatch: unpatchClass\n}];","map":{"version":3,"sources":["/Users/danielcalderon/vinology/Vinology-client/node_modules/dd-trace/packages/datadog-plugin-mongodb-core/src/unified.js"],"names":["instrument","require","createWrapConnectionCommand","tracer","config","name","wrapCommand","command","commandWithTrace","ns","ops","hostParts","address","split","options","length","host","port","topology","s","db","collection","arguments","createWrapCommand","server","createWrapMaybePromise","wrapMaybePromise","maybePromise","maybePromiseWithTrace","parent","callback","fn","callbackIndex","scope","bind","apply","patch","wp","wrap","unpatch","unwrap","patchConnection","Connection","proto","prototype","unpatchConnection","patchClass","WireProtocol","unpatchClass","module","exports","versions","file","util"],"mappings":"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","sourcesContent":["'use strict'\n\nconst { instrument } = require('./util')\n\nfunction createWrapConnectionCommand (tracer, config, name) {\n  return function wrapCommand (command) {\n    return function commandWithTrace (ns, ops) {\n      const hostParts = typeof this.address === 'string' ? this.address.split(':') : ''\n      const options = hostParts.length === 2\n        ? { host: hostParts[0], port: hostParts[1] }\n        : {} // no port means the address is a random UUID so no host either\n      const topology = { s: { options } }\n\n      ns = `${ns.db}.${ns.collection}`\n\n      return instrument(command, this, arguments, topology, ns, ops, tracer, config, { name })\n    }\n  }\n}\n\nfunction createWrapCommand (tracer, config, name) {\n  return function wrapCommand (command) {\n    return function commandWithTrace (server, ns, ops) {\n      return instrument(command, this, arguments, server, ns, ops, tracer, config, { name })\n    }\n  }\n}\n\nfunction createWrapMaybePromise (tracer, config) {\n  return function wrapMaybePromise (maybePromise) {\n    return function maybePromiseWithTrace (parent, callback, fn) {\n      const callbackIndex = arguments.length - 2\n\n      callback = arguments[callbackIndex]\n\n      if (typeof callback === 'function') {\n        arguments[callbackIndex] = tracer.scope().bind(callback)\n      }\n\n      return maybePromise.apply(this, arguments)\n    }\n  }\n}\n\nfunction patch (wp, tracer, config) {\n  this.wrap(wp, 'command', createWrapCommand(tracer, config))\n  this.wrap(wp, 'insert', createWrapCommand(tracer, config, 'insert'))\n  this.wrap(wp, 'update', createWrapCommand(tracer, config, 'update'))\n  this.wrap(wp, 'remove', createWrapCommand(tracer, config, 'remove'))\n  this.wrap(wp, 'query', createWrapCommand(tracer, config))\n  this.wrap(wp, 'getMore', createWrapCommand(tracer, config, 'getMore'))\n  this.wrap(wp, 'killCursors', createWrapCommand(tracer, config, 'killCursors'))\n}\n\nfunction unpatch (wp) {\n  this.unwrap(wp, 'command')\n  this.unwrap(wp, 'insert')\n  this.unwrap(wp, 'update')\n  this.unwrap(wp, 'remove')\n  this.unwrap(wp, 'query')\n  this.unwrap(wp, 'getMore')\n  this.unwrap(wp, 'killCursors')\n}\n\nfunction patchConnection ({ Connection }, tracer, config) {\n  const proto = Connection.prototype\n\n  this.wrap(proto, 'command', createWrapConnectionCommand(tracer, config))\n  this.wrap(proto, 'query', createWrapConnectionCommand(tracer, config))\n  this.wrap(proto, 'getMore', createWrapConnectionCommand(tracer, config, 'getMore'))\n  this.wrap(proto, 'killCursors', createWrapConnectionCommand(tracer, config, 'killCursors'))\n}\n\nfunction unpatchConnection ({ Connection }) {\n  const proto = Connection.prototype\n\n  this.unwrap(proto, 'command')\n  this.unwrap(proto, 'query')\n  this.unwrap(proto, 'getMore')\n  this.unwrap(proto, 'killCursors')\n}\n\nfunction patchClass (WireProtocol, tracer, config) {\n  this.wrap(WireProtocol.prototype, 'command', createWrapCommand(tracer, config))\n}\n\nfunction unpatchClass (WireProtocol) {\n  this.unwrap(WireProtocol.prototype, 'command')\n}\n\nmodule.exports = [\n  {\n    name: 'mongodb',\n    versions: ['>=4'],\n    file: 'lib/cmap/connection.js',\n    patch: patchConnection,\n    unpatch: unpatchConnection\n  },\n  {\n    name: 'mongodb',\n    versions: ['>=3.5.4'],\n    file: 'lib/utils.js',\n    patch (util, tracer, config) {\n      this.wrap(util, 'maybePromise', createWrapMaybePromise(tracer, config))\n    },\n    unpatch (util) {\n      this.unwrap(util, 'maybePromise')\n    }\n  },\n  {\n    name: 'mongodb',\n    versions: ['>=3.3 <4'],\n    file: 'lib/core/wireprotocol/index.js',\n    patch,\n    unpatch\n  },\n  {\n    name: 'mongodb-core',\n    versions: ['>=3.2'],\n    file: 'lib/wireprotocol/index.js',\n    patch,\n    unpatch\n  },\n  {\n    name: 'mongodb-core',\n    versions: ['~3.1.10'],\n    file: 'lib/wireprotocol/3_2_support.js',\n    patch: patchClass,\n    unpatch: unpatchClass\n  },\n  {\n    name: 'mongodb-core',\n    versions: ['~3.1.10'],\n    file: 'lib/wireprotocol/2_6_support.js',\n    patch: patchClass,\n    unpatch: unpatchClass\n  }\n]\n"]},"metadata":{},"sourceType":"script"}