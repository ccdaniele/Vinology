{"ast":null,"code":"'use strict';\n\nconst asyncHooks = require('async_hooks');\n\nconst Base = require('./base');\n\nconst metrics = require('../metrics');\n\nconst semver = require('semver'); // fixed in https://github.com/nodejs/node/pull/33801\n\n\nconst hasThenableBug = !semver.satisfies(process.version, '>=14.5 || ^12.19.0');\nlet singleton = null;\n\nclass Scope extends Base {\n  constructor(config) {\n    if (singleton) return singleton;\n    super();\n    singleton = this;\n    this._trackAsyncScope = config.trackAsyncScope && hasThenableBug;\n    this._debug = config.debug;\n    this._current = null;\n    this._spans = new Map();\n    this._types = new Map();\n    this._weaks = new WeakMap();\n    this._promises = [false];\n    this._stack = [];\n    this._depth = 0;\n    this._hook = asyncHooks.createHook({\n      init: this._init.bind(this),\n      before: this._before.bind(this),\n      after: this._after.bind(this),\n      destroy: this._destroy.bind(this)\n    });\n    this._enabled = true;\n\n    this._hook.enable();\n  }\n\n  _active() {\n    return this._current;\n  }\n\n  _activate(span, callback) {\n    const active = this._active();\n\n    this._enter(span);\n\n    try {\n      return callback();\n    } finally {\n      this._exit(active);\n    }\n  }\n\n  _enter(span) {\n    this._depth++;\n    this._stack[this._depth] = this._current;\n    this._current = span;\n    this._promises[this._depth] = false;\n  }\n\n  _exit(span) {\n    this._trackAsyncScope && this._await(span);\n    this._current = span;\n    this._stack[this._depth] = null;\n    this._depth--;\n  }\n\n  _exitNative() {\n    this._current = null;\n    this._promises[0] = false;\n  }\n\n  _await(span) {\n    if (!this._promises[this._depth]) return;\n    this._enabled = false;\n\n    this._awaitAsync(span);\n\n    this._enabled = true;\n  } // https://github.com/nodejs/node/issues/22360\n\n\n  async _awaitAsync(span) {\n    await {\n      then: resolve => {\n        this._current = span;\n        resolve();\n      }\n    };\n  }\n\n  _initPromise() {\n    if (!this._promises[this._depth]) {\n      this._promises[this._depth] = true;\n\n      this._await(this._current);\n    }\n  }\n\n  _init(asyncId, type, triggerAsyncId, resource) {\n    if (!this._enabled) return;\n\n    this._spans.set(asyncId, this._current);\n\n    this._types.set(asyncId, type);\n\n    if (this._debug) {\n      metrics.increment('runtime.node.async.resources');\n      metrics.increment('runtime.node.async.resources.by.type', `resource_type:${type}`);\n    }\n\n    if (this._trackAsyncScope && type === 'PROMISE') {\n      this._initPromise();\n    }\n  }\n\n  _before(asyncId) {\n    this._depth === 0 && this._exitNative();\n\n    this._enter(this._spans.get(asyncId));\n  }\n\n  _after() {\n    this._exit(this._stack[this._depth]);\n  }\n\n  _destroy(asyncId) {\n    const type = this._types.get(asyncId);\n\n    if (type && this._debug) {\n      metrics.decrement('runtime.node.async.resources');\n      metrics.decrement('runtime.node.async.resources.by.type', `resource_type:${type}`);\n    }\n\n    this._spans.delete(asyncId);\n\n    this._types.delete(asyncId);\n  }\n\n}\n\nmodule.exports = Scope;","map":{"version":3,"sources":["/Users/danielcalderon/vinology/Vinology-client/node_modules/dd-trace/packages/dd-trace/src/scope/async_hooks.js"],"names":["asyncHooks","require","Base","metrics","semver","hasThenableBug","satisfies","process","version","singleton","Scope","constructor","config","_trackAsyncScope","trackAsyncScope","_debug","debug","_current","_spans","Map","_types","_weaks","WeakMap","_promises","_stack","_depth","_hook","createHook","init","_init","bind","before","_before","after","_after","destroy","_destroy","_enabled","enable","_active","_activate","span","callback","active","_enter","_exit","_await","_exitNative","_awaitAsync","then","resolve","_initPromise","asyncId","type","triggerAsyncId","resource","set","increment","get","decrement","delete","module","exports"],"mappings":"AAAA;;AAEA,MAAMA,UAAU,GAAGC,OAAO,CAAC,aAAD,CAA1B;;AACA,MAAMC,IAAI,GAAGD,OAAO,CAAC,QAAD,CAApB;;AACA,MAAME,OAAO,GAAGF,OAAO,CAAC,YAAD,CAAvB;;AACA,MAAMG,MAAM,GAAGH,OAAO,CAAC,QAAD,CAAtB,C,CAEA;;;AACA,MAAMI,cAAc,GAAG,CAACD,MAAM,CAACE,SAAP,CAAiBC,OAAO,CAACC,OAAzB,EAAkC,oBAAlC,CAAxB;AAEA,IAAIC,SAAS,GAAG,IAAhB;;AAEA,MAAMC,KAAN,SAAoBR,IAApB,CAAyB;AACvBS,EAAAA,WAAW,CAAEC,MAAF,EAAU;AACnB,QAAIH,SAAJ,EAAe,OAAOA,SAAP;AAEf;AAEAA,IAAAA,SAAS,GAAG,IAAZ;AAEA,SAAKI,gBAAL,GAAwBD,MAAM,CAACE,eAAP,IAA0BT,cAAlD;AACA,SAAKU,MAAL,GAAcH,MAAM,CAACI,KAArB;AACA,SAAKC,QAAL,GAAgB,IAAhB;AACA,SAAKC,MAAL,GAAc,IAAIC,GAAJ,EAAd;AACA,SAAKC,MAAL,GAAc,IAAID,GAAJ,EAAd;AACA,SAAKE,MAAL,GAAc,IAAIC,OAAJ,EAAd;AACA,SAAKC,SAAL,GAAiB,CAAC,KAAD,CAAjB;AACA,SAAKC,MAAL,GAAc,EAAd;AACA,SAAKC,MAAL,GAAc,CAAd;AACA,SAAKC,KAAL,GAAa1B,UAAU,CAAC2B,UAAX,CAAsB;AACjCC,MAAAA,IAAI,EAAE,KAAKC,KAAL,CAAWC,IAAX,CAAgB,IAAhB,CAD2B;AAEjCC,MAAAA,MAAM,EAAE,KAAKC,OAAL,CAAaF,IAAb,CAAkB,IAAlB,CAFyB;AAGjCG,MAAAA,KAAK,EAAE,KAAKC,MAAL,CAAYJ,IAAZ,CAAiB,IAAjB,CAH0B;AAIjCK,MAAAA,OAAO,EAAE,KAAKC,QAAL,CAAcN,IAAd,CAAmB,IAAnB;AAJwB,KAAtB,CAAb;AAOA,SAAKO,QAAL,GAAgB,IAAhB;;AACA,SAAKX,KAAL,CAAWY,MAAX;AACD;;AAEDC,EAAAA,OAAO,GAAI;AACT,WAAO,KAAKtB,QAAZ;AACD;;AAEDuB,EAAAA,SAAS,CAAEC,IAAF,EAAQC,QAAR,EAAkB;AACzB,UAAMC,MAAM,GAAG,KAAKJ,OAAL,EAAf;;AAEA,SAAKK,MAAL,CAAYH,IAAZ;;AAEA,QAAI;AACF,aAAOC,QAAQ,EAAf;AACD,KAFD,SAEU;AACR,WAAKG,KAAL,CAAWF,MAAX;AACD;AACF;;AAEDC,EAAAA,MAAM,CAAEH,IAAF,EAAQ;AACZ,SAAKhB,MAAL;AACA,SAAKD,MAAL,CAAY,KAAKC,MAAjB,IAA2B,KAAKR,QAAhC;AACA,SAAKA,QAAL,GAAgBwB,IAAhB;AACA,SAAKlB,SAAL,CAAe,KAAKE,MAApB,IAA8B,KAA9B;AACD;;AAEDoB,EAAAA,KAAK,CAAEJ,IAAF,EAAQ;AACX,SAAK5B,gBAAL,IAAyB,KAAKiC,MAAL,CAAYL,IAAZ,CAAzB;AACA,SAAKxB,QAAL,GAAgBwB,IAAhB;AACA,SAAKjB,MAAL,CAAY,KAAKC,MAAjB,IAA2B,IAA3B;AACA,SAAKA,MAAL;AACD;;AAEDsB,EAAAA,WAAW,GAAI;AACb,SAAK9B,QAAL,GAAgB,IAAhB;AACA,SAAKM,SAAL,CAAe,CAAf,IAAoB,KAApB;AACD;;AAEDuB,EAAAA,MAAM,CAAEL,IAAF,EAAQ;AACZ,QAAI,CAAC,KAAKlB,SAAL,CAAe,KAAKE,MAApB,CAAL,EAAkC;AAElC,SAAKY,QAAL,GAAgB,KAAhB;;AACA,SAAKW,WAAL,CAAiBP,IAAjB;;AACA,SAAKJ,QAAL,GAAgB,IAAhB;AACD,GArEsB,CAuEvB;;;AACiB,QAAXW,WAAW,CAAEP,IAAF,EAAQ;AACvB,UAAM;AACJQ,MAAAA,IAAI,EAAGC,OAAD,IAAa;AACjB,aAAKjC,QAAL,GAAgBwB,IAAhB;AACAS,QAAAA,OAAO;AACR;AAJG,KAAN;AAMD;;AAEDC,EAAAA,YAAY,GAAI;AACd,QAAI,CAAC,KAAK5B,SAAL,CAAe,KAAKE,MAApB,CAAL,EAAkC;AAChC,WAAKF,SAAL,CAAe,KAAKE,MAApB,IAA8B,IAA9B;;AACA,WAAKqB,MAAL,CAAY,KAAK7B,QAAjB;AACD;AACF;;AAEDY,EAAAA,KAAK,CAAEuB,OAAF,EAAWC,IAAX,EAAiBC,cAAjB,EAAiCC,QAAjC,EAA2C;AAC9C,QAAI,CAAC,KAAKlB,QAAV,EAAoB;;AAEpB,SAAKnB,MAAL,CAAYsC,GAAZ,CAAgBJ,OAAhB,EAAyB,KAAKnC,QAA9B;;AACA,SAAKG,MAAL,CAAYoC,GAAZ,CAAgBJ,OAAhB,EAAyBC,IAAzB;;AAEA,QAAI,KAAKtC,MAAT,EAAiB;AACfZ,MAAAA,OAAO,CAACsD,SAAR,CAAkB,8BAAlB;AACAtD,MAAAA,OAAO,CAACsD,SAAR,CAAkB,sCAAlB,EAA2D,iBAAgBJ,IAAK,EAAhF;AACD;;AAED,QAAI,KAAKxC,gBAAL,IAAyBwC,IAAI,KAAK,SAAtC,EAAiD;AAC/C,WAAKF,YAAL;AACD;AACF;;AAEDnB,EAAAA,OAAO,CAAEoB,OAAF,EAAW;AAChB,SAAK3B,MAAL,KAAgB,CAAhB,IAAqB,KAAKsB,WAAL,EAArB;;AACA,SAAKH,MAAL,CAAY,KAAK1B,MAAL,CAAYwC,GAAZ,CAAgBN,OAAhB,CAAZ;AACD;;AAEDlB,EAAAA,MAAM,GAAI;AACR,SAAKW,KAAL,CAAW,KAAKrB,MAAL,CAAY,KAAKC,MAAjB,CAAX;AACD;;AAEDW,EAAAA,QAAQ,CAAEgB,OAAF,EAAW;AACjB,UAAMC,IAAI,GAAG,KAAKjC,MAAL,CAAYsC,GAAZ,CAAgBN,OAAhB,CAAb;;AAEA,QAAIC,IAAI,IAAI,KAAKtC,MAAjB,EAAyB;AACvBZ,MAAAA,OAAO,CAACwD,SAAR,CAAkB,8BAAlB;AACAxD,MAAAA,OAAO,CAACwD,SAAR,CAAkB,sCAAlB,EAA2D,iBAAgBN,IAAK,EAAhF;AACD;;AAED,SAAKnC,MAAL,CAAY0C,MAAZ,CAAmBR,OAAnB;;AACA,SAAKhC,MAAL,CAAYwC,MAAZ,CAAmBR,OAAnB;AACD;;AA3HsB;;AA8HzBS,MAAM,CAACC,OAAP,GAAiBpD,KAAjB","sourcesContent":["'use strict'\n\nconst asyncHooks = require('async_hooks')\nconst Base = require('./base')\nconst metrics = require('../metrics')\nconst semver = require('semver')\n\n// fixed in https://github.com/nodejs/node/pull/33801\nconst hasThenableBug = !semver.satisfies(process.version, '>=14.5 || ^12.19.0')\n\nlet singleton = null\n\nclass Scope extends Base {\n  constructor (config) {\n    if (singleton) return singleton\n\n    super()\n\n    singleton = this\n\n    this._trackAsyncScope = config.trackAsyncScope && hasThenableBug\n    this._debug = config.debug\n    this._current = null\n    this._spans = new Map()\n    this._types = new Map()\n    this._weaks = new WeakMap()\n    this._promises = [false]\n    this._stack = []\n    this._depth = 0\n    this._hook = asyncHooks.createHook({\n      init: this._init.bind(this),\n      before: this._before.bind(this),\n      after: this._after.bind(this),\n      destroy: this._destroy.bind(this)\n    })\n\n    this._enabled = true\n    this._hook.enable()\n  }\n\n  _active () {\n    return this._current\n  }\n\n  _activate (span, callback) {\n    const active = this._active()\n\n    this._enter(span)\n\n    try {\n      return callback()\n    } finally {\n      this._exit(active)\n    }\n  }\n\n  _enter (span) {\n    this._depth++\n    this._stack[this._depth] = this._current\n    this._current = span\n    this._promises[this._depth] = false\n  }\n\n  _exit (span) {\n    this._trackAsyncScope && this._await(span)\n    this._current = span\n    this._stack[this._depth] = null\n    this._depth--\n  }\n\n  _exitNative () {\n    this._current = null\n    this._promises[0] = false\n  }\n\n  _await (span) {\n    if (!this._promises[this._depth]) return\n\n    this._enabled = false\n    this._awaitAsync(span)\n    this._enabled = true\n  }\n\n  // https://github.com/nodejs/node/issues/22360\n  async _awaitAsync (span) {\n    await {\n      then: (resolve) => {\n        this._current = span\n        resolve()\n      }\n    }\n  }\n\n  _initPromise () {\n    if (!this._promises[this._depth]) {\n      this._promises[this._depth] = true\n      this._await(this._current)\n    }\n  }\n\n  _init (asyncId, type, triggerAsyncId, resource) {\n    if (!this._enabled) return\n\n    this._spans.set(asyncId, this._current)\n    this._types.set(asyncId, type)\n\n    if (this._debug) {\n      metrics.increment('runtime.node.async.resources')\n      metrics.increment('runtime.node.async.resources.by.type', `resource_type:${type}`)\n    }\n\n    if (this._trackAsyncScope && type === 'PROMISE') {\n      this._initPromise()\n    }\n  }\n\n  _before (asyncId) {\n    this._depth === 0 && this._exitNative()\n    this._enter(this._spans.get(asyncId))\n  }\n\n  _after () {\n    this._exit(this._stack[this._depth])\n  }\n\n  _destroy (asyncId) {\n    const type = this._types.get(asyncId)\n\n    if (type && this._debug) {\n      metrics.decrement('runtime.node.async.resources')\n      metrics.decrement('runtime.node.async.resources.by.type', `resource_type:${type}`)\n    }\n\n    this._spans.delete(asyncId)\n    this._types.delete(asyncId)\n  }\n}\n\nmodule.exports = Scope\n"]},"metadata":{},"sourceType":"script"}