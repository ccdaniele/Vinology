{"ast":null,"code":"'use strict';\n\nconst methods = require('methods').concat('all');\n\nconst web = require('../../dd-trace/src/plugins/util/web');\n\nfunction createWrapFastify(tracer, config) {\n  config = web.normalizeConfig(config);\n  return function wrapFastify(fastify) {\n    if (typeof fastify !== 'function') return fastify;\n    return function fastifyWithTrace() {\n      const app = fastify.apply(this, arguments);\n      if (!app) return app;\n\n      if (typeof app.addHook === 'function') {\n        app.addHook('onRequest', createOnRequest(tracer, config));\n        app.addHook('preHandler', preHandler);\n        app.addHook = createWrapAddHook(tracer, config)(app.addHook);\n      }\n\n      methods.forEach(method => {\n        app[method] = wrapMethod(app[method]);\n      });\n      app.route = wrapRoute(app.route);\n      return app;\n    };\n  };\n}\n\nfunction createWrapAddHook(tracer, config) {\n  return function wrapAddHook(addHook) {\n    return function addHookWithTrace(name, fn) {\n      fn = arguments[arguments.length - 1];\n      if (typeof fn !== 'function') return addHook.apply(this, arguments);\n      arguments[arguments.length - 1] = safeWrap(fn, function (request, reply, done) {\n        const req = getReq(request);\n        if (!req) return fn.apply(this, arguments);\n        done = arguments[arguments.length - 1];\n\n        try {\n          if (typeof done === 'function') {\n            arguments[arguments.length - 1] = function (err) {\n              web.addError(req, err);\n              return done.apply(this, arguments);\n            };\n\n            return fn.apply(this, arguments);\n          } else {\n            const promise = fn.apply(this, arguments);\n\n            if (promise && typeof promise.catch === 'function') {\n              return promise.catch(err => {\n                web.addError(req, err);\n                throw err;\n              });\n            }\n\n            return promise;\n          }\n        } catch (e) {\n          web.addError(req, e);\n          throw e;\n        }\n      });\n      return addHook.apply(this, arguments);\n    };\n  };\n}\n\nfunction createOnRequest(tracer, config) {\n  return function onRequest(request, reply, next) {\n    if (typeof next !== 'function') return;\n    const req = getReq(request);\n    const res = getRes(reply);\n    const name = 'fastify.request';\n    return web.instrument(tracer, config, req, res, name, () => next());\n  };\n}\n\nfunction preHandler(request, reply, next) {\n  if (typeof next !== 'function') return;\n  if (!reply || typeof reply.send !== 'function') return next();\n  reply.send = wrapSend(reply.send);\n  next();\n}\n\nfunction wrapSend(send) {\n  return function sendWithTrace(payload) {\n    const req = getReq(this && this.request);\n    web.addError(req, payload);\n    return send.apply(this, arguments);\n  };\n}\n\nfunction wrapRoute(route) {\n  if (typeof route !== 'function') return route;\n  return function routeWithTrace(opts) {\n    opts.handler = wrapHandler(opts.handler);\n    return route.apply(this, arguments);\n  };\n}\n\nfunction wrapMethod(method) {\n  if (typeof method !== 'function') return method;\n  return function methodWithTrace(url, opts, handler) {\n    const lastIndex = arguments.length - 1;\n    handler = arguments[lastIndex];\n\n    if (typeof handler === 'function') {\n      arguments[lastIndex] = wrapHandler(handler);\n    } else if (handler) {\n      arguments[lastIndex].handler = wrapHandler(handler.handler);\n    }\n\n    return method.apply(this, arguments);\n  };\n}\n\nfunction wrapHandler(handler) {\n  if (!handler || typeof handler !== 'function' || handler.name === 'handlerWithTrace') {\n    return handler;\n  }\n\n  return function handlerWithTrace(request, reply) {\n    const req = getReq(request);\n    return web.reactivate(req, () => handler.apply(this, arguments));\n  };\n} // TODO: move this to a common util\n\n\nfunction safeWrap(fn, wrapper) {\n  Object.defineProperty(wrapper, 'length', Object.getOwnPropertyDescriptor(fn, 'length'));\n  return wrapper;\n}\n\nfunction getReq(request) {\n  return request && (request.raw || request.req || request);\n}\n\nfunction getRes(reply) {\n  return reply && (reply.raw || reply.res || reply);\n}\n\nmodule.exports = [{\n  name: 'fastify',\n  versions: ['>=1'],\n\n  patch(fastify, tracer, config) {\n    // `fastify` is a function so we return a wrapper that will replace its export.\n    return this.wrapExport(fastify, createWrapFastify(tracer, config)(fastify));\n  },\n\n  unpatch(fastify) {\n    this.unwrapExport(fastify);\n  }\n\n}];","map":{"version":3,"sources":["/Users/danielcalderon/vinology/Vinology-client/node_modules/dd-trace/packages/datadog-plugin-fastify/src/fastify.js"],"names":["methods","require","concat","web","createWrapFastify","tracer","config","normalizeConfig","wrapFastify","fastify","fastifyWithTrace","app","apply","arguments","addHook","createOnRequest","preHandler","createWrapAddHook","forEach","method","wrapMethod","route","wrapRoute","wrapAddHook","addHookWithTrace","name","fn","length","safeWrap","request","reply","done","req","getReq","err","addError","promise","catch","e","onRequest","next","res","getRes","instrument","send","wrapSend","sendWithTrace","payload","routeWithTrace","opts","handler","wrapHandler","methodWithTrace","url","lastIndex","handlerWithTrace","reactivate","wrapper","Object","defineProperty","getOwnPropertyDescriptor","raw","module","exports","versions","patch","wrapExport","unpatch","unwrapExport"],"mappings":"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","sourcesContent":["'use strict'\n\nconst methods = require('methods').concat('all')\nconst web = require('../../dd-trace/src/plugins/util/web')\n\nfunction createWrapFastify (tracer, config) {\n  config = web.normalizeConfig(config)\n\n  return function wrapFastify (fastify) {\n    if (typeof fastify !== 'function') return fastify\n\n    return function fastifyWithTrace () {\n      const app = fastify.apply(this, arguments)\n\n      if (!app) return app\n\n      if (typeof app.addHook === 'function') {\n        app.addHook('onRequest', createOnRequest(tracer, config))\n        app.addHook('preHandler', preHandler)\n        app.addHook = createWrapAddHook(tracer, config)(app.addHook)\n      }\n\n      methods.forEach(method => {\n        app[method] = wrapMethod(app[method])\n      })\n\n      app.route = wrapRoute(app.route)\n\n      return app\n    }\n  }\n}\n\nfunction createWrapAddHook (tracer, config) {\n  return function wrapAddHook (addHook) {\n    return function addHookWithTrace (name, fn) {\n      fn = arguments[arguments.length - 1]\n\n      if (typeof fn !== 'function') return addHook.apply(this, arguments)\n\n      arguments[arguments.length - 1] = safeWrap(fn, function (request, reply, done) {\n        const req = getReq(request)\n\n        if (!req) return fn.apply(this, arguments)\n\n        done = arguments[arguments.length - 1]\n\n        try {\n          if (typeof done === 'function') {\n            arguments[arguments.length - 1] = function (err) {\n              web.addError(req, err)\n              return done.apply(this, arguments)\n            }\n\n            return fn.apply(this, arguments)\n          } else {\n            const promise = fn.apply(this, arguments)\n\n            if (promise && typeof promise.catch === 'function') {\n              return promise.catch(err => {\n                web.addError(req, err)\n                throw err\n              })\n            }\n\n            return promise\n          }\n        } catch (e) {\n          web.addError(req, e)\n          throw e\n        }\n      })\n\n      return addHook.apply(this, arguments)\n    }\n  }\n}\n\nfunction createOnRequest (tracer, config) {\n  return function onRequest (request, reply, next) {\n    if (typeof next !== 'function') return\n\n    const req = getReq(request)\n    const res = getRes(reply)\n    const name = 'fastify.request'\n\n    return web.instrument(tracer, config, req, res, name, () => next())\n  }\n}\n\nfunction preHandler (request, reply, next) {\n  if (typeof next !== 'function') return\n  if (!reply || typeof reply.send !== 'function') return next()\n\n  reply.send = wrapSend(reply.send)\n\n  next()\n}\n\nfunction wrapSend (send) {\n  return function sendWithTrace (payload) {\n    const req = getReq(this && this.request)\n\n    web.addError(req, payload)\n\n    return send.apply(this, arguments)\n  }\n}\n\nfunction wrapRoute (route) {\n  if (typeof route !== 'function') return route\n\n  return function routeWithTrace (opts) {\n    opts.handler = wrapHandler(opts.handler)\n\n    return route.apply(this, arguments)\n  }\n}\n\nfunction wrapMethod (method) {\n  if (typeof method !== 'function') return method\n\n  return function methodWithTrace (url, opts, handler) {\n    const lastIndex = arguments.length - 1\n\n    handler = arguments[lastIndex]\n\n    if (typeof handler === 'function') {\n      arguments[lastIndex] = wrapHandler(handler)\n    } else if (handler) {\n      arguments[lastIndex].handler = wrapHandler(handler.handler)\n    }\n\n    return method.apply(this, arguments)\n  }\n}\n\nfunction wrapHandler (handler) {\n  if (!handler || typeof handler !== 'function' || handler.name === 'handlerWithTrace') {\n    return handler\n  }\n\n  return function handlerWithTrace (request, reply) {\n    const req = getReq(request)\n\n    return web.reactivate(req, () => handler.apply(this, arguments))\n  }\n}\n\n// TODO: move this to a common util\nfunction safeWrap (fn, wrapper) {\n  Object.defineProperty(wrapper, 'length', Object.getOwnPropertyDescriptor(fn, 'length'))\n\n  return wrapper\n}\n\nfunction getReq (request) {\n  return request && (request.raw || request.req || request)\n}\n\nfunction getRes (reply) {\n  return reply && (reply.raw || reply.res || reply)\n}\n\nmodule.exports = [\n  {\n    name: 'fastify',\n    versions: ['>=1'],\n    patch (fastify, tracer, config) {\n      // `fastify` is a function so we return a wrapper that will replace its export.\n      return this.wrapExport(fastify, createWrapFastify(tracer, config)(fastify))\n    },\n    unpatch (fastify) {\n      this.unwrapExport(fastify)\n    }\n  }\n]\n"]},"metadata":{},"sourceType":"script"}