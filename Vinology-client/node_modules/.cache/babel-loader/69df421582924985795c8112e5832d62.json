{"ast":null,"code":"'use strict';\n\nconst Tags = require('../../../ext/tags');\n\nconst Kinds = require('../../../ext/kinds');\n\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler');\n\nfunction startSpan(tracer, config, operation, resource) {\n  const childOf = tracer.scope().active();\n  const span = tracer.startSpan(`couchbase.${operation}`, {\n    childOf,\n    tags: {\n      'db.type': 'couchbase',\n      'component': 'couchbase',\n      'service.name': config.service || `${tracer._service}-couchbase`,\n      'resource.name': resource,\n      [Tags.SPAN_KIND]: Kinds.CLIENT\n    }\n  });\n  analyticsSampler.sample(span, config.measured);\n  return span;\n}\n\nfunction onRequestFinish(emitter, span) {\n  emitter.once('rows', () => {\n    span.finish();\n  });\n  emitter.once('error', err => {\n    span.setTag(Tags.ERROR, err);\n    span.finish();\n  });\n}\n\nfunction createWrapMaybeInvoke(tracer) {\n  return function wrapMaybeInvoke(_maybeInvoke) {\n    return function maybeInvokeWithTrace(fn, args) {\n      if (!Array.isArray(args)) return _maybeInvoke.apply(this, arguments);\n      const scope = tracer.scope();\n      const callbackIndex = args.length - 1;\n      const callback = args[callbackIndex];\n\n      if (callback instanceof Function) {\n        args[callbackIndex] = scope.bind(callback);\n      }\n\n      return scope.bind(_maybeInvoke).apply(this, arguments);\n    };\n  };\n}\n\nfunction createWrapQuery(tracer) {\n  return function wrapQuery(query) {\n    return function queryWithTrace(q, params, callback) {\n      const scope = tracer.scope();\n      callback = arguments[arguments.length - 1];\n\n      if (typeof callback === 'function') {\n        arguments[arguments.length - 1] = scope.bind(callback);\n      }\n\n      return scope.bind(query.apply(this, arguments));\n    };\n  };\n}\n\nfunction createWrapN1qlReq(tracer, config) {\n  return function wrapN1qlReq(_n1qlReq) {\n    return function n1qlReqWithTrace(host, q, adhoc, emitter) {\n      if (!emitter || !emitter.once) return _n1qlReq.apply(this, arguments);\n      const scope = tracer.scope();\n      const n1qlQuery = q && q.statement;\n      const span = startSpan(tracer, config, 'query', n1qlQuery);\n      span.setTag('span.type', 'sql');\n      addBucketTag(span, this);\n      onRequestFinish(emitter, span);\n      return scope.bind(_n1qlReq, span).apply(this, arguments);\n    };\n  };\n}\n\nfunction createWrapStore(tracer, config, operation) {\n  return function wrapStore(store) {\n    return function storeWithTrace(key, value, options, callback) {\n      const callbackIndex = findCallbackIndex(arguments);\n      if (callbackIndex < 0) return store.apply(this, arguments);\n      const scope = tracer.scope();\n      const span = startSpan(tracer, config, operation);\n      addBucketTag(span, this);\n      arguments[callbackIndex] = wrapCallback(span, arguments[callbackIndex]);\n      return scope.bind(store, span).apply(this, arguments);\n    };\n  };\n}\n\nfunction addBucketTag(span, bucket) {\n  span.setTag('couchbase.bucket.name', bucket.name || bucket._name);\n}\n\nfunction findCallbackIndex(args) {\n  for (let i = args.length - 1; i >= 2; i--) {\n    if (typeof args[i] === 'function') return i;\n  }\n\n  return -1;\n}\n\nfunction wrapCallback(span, callback) {\n  return function (err, result) {\n    span.setTag('error', err);\n    span.finish();\n    return callback.apply(this, arguments);\n  };\n}\n\nmodule.exports = [{\n  name: 'couchbase',\n  versions: ['^2.6.5'],\n  file: 'lib/bucket.js',\n\n  patch(Bucket, tracer, config) {\n    tracer.scope().bind(Bucket.prototype);\n    this.wrap(Bucket.prototype, '_maybeInvoke', createWrapMaybeInvoke(tracer, config));\n    this.wrap(Bucket.prototype, 'query', createWrapQuery(tracer));\n    this.wrap(Bucket.prototype, '_n1qlReq', createWrapN1qlReq(tracer, config));\n    this.wrap(Bucket.prototype, 'upsert', createWrapStore(tracer, config, 'upsert'));\n    this.wrap(Bucket.prototype, 'insert', createWrapStore(tracer, config, 'insert'));\n    this.wrap(Bucket.prototype, 'replace', createWrapStore(tracer, config, 'replace'));\n    this.wrap(Bucket.prototype, 'append', createWrapStore(tracer, config, 'append'));\n    this.wrap(Bucket.prototype, 'prepend', createWrapStore(tracer, config, 'prepend'));\n  },\n\n  unpatch(Bucket, tracer) {\n    tracer.scope().unbind(Bucket.prototype);\n    this.unwrap(Bucket.prototype, '_maybeInvoke');\n    this.unwrap(Bucket.prototype, 'query');\n    this.unwrap(Bucket.prototype, '_n1qlReq');\n    this.unwrap(Bucket.prototype, 'upsert');\n    this.unwrap(Bucket.prototype, 'insert');\n    this.unwrap(Bucket.prototype, 'replace');\n    this.unwrap(Bucket.prototype, 'append');\n    this.unwrap(Bucket.prototype, 'prepend');\n  }\n\n}, {\n  name: 'couchbase',\n  versions: ['^2.6.5'],\n  file: 'lib/cluster.js',\n\n  patch(Cluster, tracer, config) {\n    this.wrap(Cluster.prototype, '_maybeInvoke', createWrapMaybeInvoke(tracer, config));\n    this.wrap(Cluster.prototype, 'query', createWrapQuery(tracer));\n  },\n\n  unpatch(Cluster) {\n    this.unwrap(Cluster.prototype, '_maybeInvoke');\n    this.unwrap(Cluster.prototype, 'query');\n  }\n\n}];","map":{"version":3,"sources":["/Users/danielcalderon/vinology/Vinology-client/node_modules/dd-trace/packages/datadog-plugin-couchbase/src/index.js"],"names":["Tags","require","Kinds","analyticsSampler","startSpan","tracer","config","operation","resource","childOf","scope","active","span","tags","service","_service","SPAN_KIND","CLIENT","sample","measured","onRequestFinish","emitter","once","finish","err","setTag","ERROR","createWrapMaybeInvoke","wrapMaybeInvoke","_maybeInvoke","maybeInvokeWithTrace","fn","args","Array","isArray","apply","arguments","callbackIndex","length","callback","Function","bind","createWrapQuery","wrapQuery","query","queryWithTrace","q","params","createWrapN1qlReq","wrapN1qlReq","_n1qlReq","n1qlReqWithTrace","host","adhoc","n1qlQuery","statement","addBucketTag","createWrapStore","wrapStore","store","storeWithTrace","key","value","options","findCallbackIndex","wrapCallback","bucket","name","_name","i","result","module","exports","versions","file","patch","Bucket","prototype","wrap","unpatch","unbind","unwrap","Cluster"],"mappings":"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","sourcesContent":["'use strict'\n\nconst Tags = require('../../../ext/tags')\nconst Kinds = require('../../../ext/kinds')\nconst analyticsSampler = require('../../dd-trace/src/analytics_sampler')\n\nfunction startSpan (tracer, config, operation, resource) {\n  const childOf = tracer.scope().active()\n  const span = tracer.startSpan(`couchbase.${operation}`, {\n    childOf,\n    tags: {\n      'db.type': 'couchbase',\n      'component': 'couchbase',\n      'service.name': config.service || `${tracer._service}-couchbase`,\n      'resource.name': resource,\n      [Tags.SPAN_KIND]: Kinds.CLIENT\n    }\n  })\n\n  analyticsSampler.sample(span, config.measured)\n\n  return span\n}\n\nfunction onRequestFinish (emitter, span) {\n  emitter.once('rows', () => {\n    span.finish()\n  })\n  emitter.once('error', (err) => {\n    span.setTag(Tags.ERROR, err)\n    span.finish()\n  })\n}\n\nfunction createWrapMaybeInvoke (tracer) {\n  return function wrapMaybeInvoke (_maybeInvoke) {\n    return function maybeInvokeWithTrace (fn, args) {\n      if (!Array.isArray(args)) return _maybeInvoke.apply(this, arguments)\n\n      const scope = tracer.scope()\n      const callbackIndex = args.length - 1\n      const callback = args[callbackIndex]\n\n      if (callback instanceof Function) {\n        args[callbackIndex] = scope.bind(callback)\n      }\n\n      return scope.bind(_maybeInvoke).apply(this, arguments)\n    }\n  }\n}\n\nfunction createWrapQuery (tracer) {\n  return function wrapQuery (query) {\n    return function queryWithTrace (q, params, callback) {\n      const scope = tracer.scope()\n\n      callback = arguments[arguments.length - 1]\n\n      if (typeof callback === 'function') {\n        arguments[arguments.length - 1] = scope.bind(callback)\n      }\n\n      return scope.bind(query.apply(this, arguments))\n    }\n  }\n}\n\nfunction createWrapN1qlReq (tracer, config) {\n  return function wrapN1qlReq (_n1qlReq) {\n    return function n1qlReqWithTrace (host, q, adhoc, emitter) {\n      if (!emitter || !emitter.once) return _n1qlReq.apply(this, arguments)\n\n      const scope = tracer.scope()\n      const n1qlQuery = q && q.statement\n      const span = startSpan(tracer, config, 'query', n1qlQuery)\n\n      span.setTag('span.type', 'sql')\n\n      addBucketTag(span, this)\n      onRequestFinish(emitter, span)\n\n      return scope.bind(_n1qlReq, span).apply(this, arguments)\n    }\n  }\n}\n\nfunction createWrapStore (tracer, config, operation) {\n  return function wrapStore (store) {\n    return function storeWithTrace (key, value, options, callback) {\n      const callbackIndex = findCallbackIndex(arguments)\n\n      if (callbackIndex < 0) return store.apply(this, arguments)\n\n      const scope = tracer.scope()\n      const span = startSpan(tracer, config, operation)\n\n      addBucketTag(span, this)\n\n      arguments[callbackIndex] = wrapCallback(span, arguments[callbackIndex])\n\n      return scope.bind(store, span).apply(this, arguments)\n    }\n  }\n}\n\nfunction addBucketTag (span, bucket) {\n  span.setTag('couchbase.bucket.name', bucket.name || bucket._name)\n}\n\nfunction findCallbackIndex (args) {\n  for (let i = args.length - 1; i >= 2; i--) {\n    if (typeof args[i] === 'function') return i\n  }\n\n  return -1\n}\n\nfunction wrapCallback (span, callback) {\n  return function (err, result) {\n    span.setTag('error', err)\n    span.finish()\n\n    return callback.apply(this, arguments)\n  }\n}\n\nmodule.exports = [\n  {\n    name: 'couchbase',\n    versions: ['^2.6.5'],\n    file: 'lib/bucket.js',\n    patch (Bucket, tracer, config) {\n      tracer.scope().bind(Bucket.prototype)\n\n      this.wrap(Bucket.prototype, '_maybeInvoke', createWrapMaybeInvoke(tracer, config))\n      this.wrap(Bucket.prototype, 'query', createWrapQuery(tracer))\n      this.wrap(Bucket.prototype, '_n1qlReq', createWrapN1qlReq(tracer, config))\n      this.wrap(Bucket.prototype, 'upsert', createWrapStore(tracer, config, 'upsert'))\n      this.wrap(Bucket.prototype, 'insert', createWrapStore(tracer, config, 'insert'))\n      this.wrap(Bucket.prototype, 'replace', createWrapStore(tracer, config, 'replace'))\n      this.wrap(Bucket.prototype, 'append', createWrapStore(tracer, config, 'append'))\n      this.wrap(Bucket.prototype, 'prepend', createWrapStore(tracer, config, 'prepend'))\n    },\n    unpatch (Bucket, tracer) {\n      tracer.scope().unbind(Bucket.prototype)\n\n      this.unwrap(Bucket.prototype, '_maybeInvoke')\n      this.unwrap(Bucket.prototype, 'query')\n      this.unwrap(Bucket.prototype, '_n1qlReq')\n      this.unwrap(Bucket.prototype, 'upsert')\n      this.unwrap(Bucket.prototype, 'insert')\n      this.unwrap(Bucket.prototype, 'replace')\n      this.unwrap(Bucket.prototype, 'append')\n      this.unwrap(Bucket.prototype, 'prepend')\n    }\n  },\n  {\n    name: 'couchbase',\n    versions: ['^2.6.5'],\n    file: 'lib/cluster.js',\n    patch (Cluster, tracer, config) {\n      this.wrap(Cluster.prototype, '_maybeInvoke', createWrapMaybeInvoke(tracer, config))\n      this.wrap(Cluster.prototype, 'query', createWrapQuery(tracer))\n    },\n    unpatch (Cluster) {\n      this.unwrap(Cluster.prototype, '_maybeInvoke')\n      this.unwrap(Cluster.prototype, 'query')\n    }\n  }\n]\n"]},"metadata":{},"sourceType":"script"}