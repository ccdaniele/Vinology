{"ast":null,"code":"'use strict';\n\nconst web = require('../../dd-trace/src/plugins/util/web');\n\nfunction createWrapCallback(tracer, config) {\n  config = web.normalizeConfig(config);\n  return function wrapCallback(callback) {\n    return function callbackWithTrace() {\n      const handleRequest = callback.apply(this, arguments);\n      if (typeof handleRequest !== 'function') return handleRequest;\n      return function handleRequestWithTrace(req, res) {\n        web.instrument(tracer, config, req, res, 'koa.request');\n        return handleRequest.apply(this, arguments);\n      };\n    };\n  };\n}\n\nfunction createWrapCreateContext() {\n  return function wrapCreateContext(createContext) {\n    return function createContextWithTrace(req, res) {\n      const ctx = createContext.apply(this, arguments);\n      if (!ctx) return ctx;\n      web.patch(req);\n      web.beforeEnd(req, () => {\n        web.enterRoute(req, ctx.routePath);\n      });\n      return ctx;\n    };\n  };\n}\n\nfunction createWrapUse() {\n  return function wrapUse(use) {\n    return function useWithTrace() {\n      const result = use.apply(this, arguments);\n      if (!Array.isArray(this.middleware)) return result;\n      const fn = this.middleware.pop();\n      this.middleware.push(wrapMiddleware(fn));\n      return result;\n    };\n  };\n}\n\nfunction createWrapRegister(tracer, config) {\n  return function wrapRegister(register) {\n    return function registerWithTrace(path, methods, middleware, opts) {\n      const route = register.apply(this, arguments);\n\n      if (!Array.isArray(path) && route && Array.isArray(route.stack)) {\n        wrapStack(route);\n      }\n\n      return route;\n    };\n  };\n}\n\nfunction createWrapRouterUse(tracer, config) {\n  return function wrapUse(use) {\n    return function useWithTrace() {\n      const router = use.apply(this, arguments);\n      router.stack.forEach(wrapStack);\n      return router;\n    };\n  };\n}\n\nfunction wrapStack(layer) {\n  layer.stack = layer.stack.map(middleware => {\n    if (typeof middleware !== 'function') return middleware;\n    middleware = middleware._dd_original || middleware;\n    const wrappedMiddleware = wrapMiddleware(middleware);\n\n    const handler = function (ctx, next) {\n      if (!ctx || !web.active(ctx.req)) return middleware.apply(this, arguments);\n      web.exitRoute(ctx.req);\n      web.enterRoute(ctx.req, layer.path);\n      return wrappedMiddleware.apply(this, arguments);\n    };\n\n    handler._dd_original = middleware;\n    return handler;\n  });\n}\n\nfunction wrapMiddleware(fn) {\n  if (typeof fn !== 'function') return fn;\n  return function (ctx, next) {\n    if (!ctx) return fn.apply(this, arguments);\n    return web.wrapMiddleware(ctx.req, fn, 'koa.middleware', () => {\n      try {\n        const result = fn.apply(this, arguments);\n\n        if (result && typeof result.then === 'function') {\n          result.then(() => web.finish(ctx.req), err => web.finish(ctx.req, err));\n        } else {\n          web.finish(ctx.req);\n        }\n\n        return result;\n      } catch (e) {\n        web.finish(ctx.req, e);\n        throw e;\n      }\n    });\n  };\n}\n\nmodule.exports = [{\n  name: 'koa',\n  versions: ['>=2'],\n\n  patch(Koa, tracer, config) {\n    this.wrap(Koa.prototype, 'callback', createWrapCallback(tracer, config));\n    this.wrap(Koa.prototype, 'createContext', createWrapCreateContext(tracer, config));\n    this.wrap(Koa.prototype, 'use', createWrapUse(tracer, config));\n  },\n\n  unpatch(Koa) {\n    this.unwrap(Koa.prototype, 'callback');\n    this.unwrap(Koa.prototype, 'createContext');\n    this.unwrap(Koa.prototype, 'use');\n  }\n\n}, {\n  name: '@koa/router',\n  versions: ['>=8'],\n\n  patch(Router, tracer, config) {\n    this.wrap(Router.prototype, 'register', createWrapRegister(tracer, config));\n    this.wrap(Router.prototype, 'use', createWrapRouterUse(tracer, config));\n  },\n\n  unpatch(Router) {\n    this.unwrap(Router.prototype, 'register');\n    this.unwrap(Router.prototype, 'use');\n  }\n\n}, {\n  name: 'koa-router',\n  versions: ['>=7'],\n\n  patch(Router, tracer, config) {\n    this.wrap(Router.prototype, 'register', createWrapRegister(tracer, config));\n    this.wrap(Router.prototype, 'use', createWrapRouterUse(tracer, config));\n  },\n\n  unpatch(Router) {\n    this.unwrap(Router.prototype, 'register');\n    this.unwrap(Router.prototype, 'use');\n  }\n\n}];","map":{"version":3,"sources":["/Users/danielcalderon/vinology/Vinology-client/node_modules/dd-trace/packages/datadog-plugin-koa/src/index.js"],"names":["web","require","createWrapCallback","tracer","config","normalizeConfig","wrapCallback","callback","callbackWithTrace","handleRequest","apply","arguments","handleRequestWithTrace","req","res","instrument","createWrapCreateContext","wrapCreateContext","createContext","createContextWithTrace","ctx","patch","beforeEnd","enterRoute","routePath","createWrapUse","wrapUse","use","useWithTrace","result","Array","isArray","middleware","fn","pop","push","wrapMiddleware","createWrapRegister","wrapRegister","register","registerWithTrace","path","methods","opts","route","stack","wrapStack","createWrapRouterUse","router","forEach","layer","map","_dd_original","wrappedMiddleware","handler","next","active","exitRoute","then","finish","err","e","module","exports","name","versions","Koa","wrap","prototype","unpatch","unwrap","Router"],"mappings":"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","sourcesContent":["'use strict'\n\nconst web = require('../../dd-trace/src/plugins/util/web')\n\nfunction createWrapCallback (tracer, config) {\n  config = web.normalizeConfig(config)\n\n  return function wrapCallback (callback) {\n    return function callbackWithTrace () {\n      const handleRequest = callback.apply(this, arguments)\n\n      if (typeof handleRequest !== 'function') return handleRequest\n\n      return function handleRequestWithTrace (req, res) {\n        web.instrument(tracer, config, req, res, 'koa.request')\n\n        return handleRequest.apply(this, arguments)\n      }\n    }\n  }\n}\n\nfunction createWrapCreateContext () {\n  return function wrapCreateContext (createContext) {\n    return function createContextWithTrace (req, res) {\n      const ctx = createContext.apply(this, arguments)\n\n      if (!ctx) return ctx\n\n      web.patch(req)\n      web.beforeEnd(req, () => {\n        web.enterRoute(req, ctx.routePath)\n      })\n\n      return ctx\n    }\n  }\n}\n\nfunction createWrapUse () {\n  return function wrapUse (use) {\n    return function useWithTrace () {\n      const result = use.apply(this, arguments)\n\n      if (!Array.isArray(this.middleware)) return result\n\n      const fn = this.middleware.pop()\n\n      this.middleware.push(wrapMiddleware(fn))\n\n      return result\n    }\n  }\n}\n\nfunction createWrapRegister (tracer, config) {\n  return function wrapRegister (register) {\n    return function registerWithTrace (path, methods, middleware, opts) {\n      const route = register.apply(this, arguments)\n\n      if (!Array.isArray(path) && route && Array.isArray(route.stack)) {\n        wrapStack(route)\n      }\n\n      return route\n    }\n  }\n}\n\nfunction createWrapRouterUse (tracer, config) {\n  return function wrapUse (use) {\n    return function useWithTrace () {\n      const router = use.apply(this, arguments)\n\n      router.stack.forEach(wrapStack)\n\n      return router\n    }\n  }\n}\n\nfunction wrapStack (layer) {\n  layer.stack = layer.stack.map(middleware => {\n    if (typeof middleware !== 'function') return middleware\n\n    middleware = middleware._dd_original || middleware\n\n    const wrappedMiddleware = wrapMiddleware(middleware)\n\n    const handler = function (ctx, next) {\n      if (!ctx || !web.active(ctx.req)) return middleware.apply(this, arguments)\n\n      web.exitRoute(ctx.req)\n      web.enterRoute(ctx.req, layer.path)\n\n      return wrappedMiddleware.apply(this, arguments)\n    }\n\n    handler._dd_original = middleware\n\n    return handler\n  })\n}\n\nfunction wrapMiddleware (fn) {\n  if (typeof fn !== 'function') return fn\n\n  return function (ctx, next) {\n    if (!ctx) return fn.apply(this, arguments)\n\n    return web.wrapMiddleware(ctx.req, fn, 'koa.middleware', () => {\n      try {\n        const result = fn.apply(this, arguments)\n\n        if (result && typeof result.then === 'function') {\n          result.then(\n            () => web.finish(ctx.req),\n            err => web.finish(ctx.req, err)\n          )\n        } else {\n          web.finish(ctx.req)\n        }\n\n        return result\n      } catch (e) {\n        web.finish(ctx.req, e)\n        throw e\n      }\n    })\n  }\n}\n\nmodule.exports = [\n  {\n    name: 'koa',\n    versions: ['>=2'],\n    patch (Koa, tracer, config) {\n      this.wrap(Koa.prototype, 'callback', createWrapCallback(tracer, config))\n      this.wrap(Koa.prototype, 'createContext', createWrapCreateContext(tracer, config))\n      this.wrap(Koa.prototype, 'use', createWrapUse(tracer, config))\n    },\n    unpatch (Koa) {\n      this.unwrap(Koa.prototype, 'callback')\n      this.unwrap(Koa.prototype, 'createContext')\n      this.unwrap(Koa.prototype, 'use')\n    }\n  },\n  {\n    name: '@koa/router',\n    versions: ['>=8'],\n    patch (Router, tracer, config) {\n      this.wrap(Router.prototype, 'register', createWrapRegister(tracer, config))\n      this.wrap(Router.prototype, 'use', createWrapRouterUse(tracer, config))\n    },\n    unpatch (Router) {\n      this.unwrap(Router.prototype, 'register')\n      this.unwrap(Router.prototype, 'use')\n    }\n  },\n  {\n    name: 'koa-router',\n    versions: ['>=7'],\n    patch (Router, tracer, config) {\n      this.wrap(Router.prototype, 'register', createWrapRegister(tracer, config))\n      this.wrap(Router.prototype, 'use', createWrapRouterUse(tracer, config))\n    },\n    unpatch (Router) {\n      this.unwrap(Router.prototype, 'register')\n      this.unwrap(Router.prototype, 'use')\n    }\n  }\n]\n"]},"metadata":{},"sourceType":"script"}